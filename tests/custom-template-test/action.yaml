name: Publish container uses provided summary template
description: Test to validate that publish container uses provided summary template

runs:
  using: composite
  steps:
    - id: publish
      name: Run publish-container action with custom template
      uses: ./
      with:
        registryHost: localhost:5000
        registryUsername: testuser
        registryPassword: testpassword
        imageNames: localhost:5000/test-template
        version: 1.0.0
        context: tests/custom-template-test
        dockerfile: tests/custom-template-test/Dockerfile
        messageTemplate: |-
          ## ğŸš€ Container Build Results
          
          **Version:** {{ version }}
          **Built by:** {{ owner }}/{{ repo }}
          
          ### ğŸ“¦ Images
          {% for image in images %}
          - `{{ image }}` ğŸ”„
          {% endfor %}
          
          ### ğŸ·ï¸ Tags
          | Tag | Full Name |
          |-----|-----------|
          {% for tag in tags %}
          | `{{ tag }}` | `{{ registry }}/test-template:{{ tag }}` |
          {% endfor %}
          
          ### ğŸ“‹ Metadata
          ```json
          {
            "labels": {{ labels | tojson }}
          }
          ```

    - name: Assert custom template was rendered correctly
      shell: bash
      if: always()
      run: |
        summary=$(cat << 'DELIMITER'
        ${{ steps.publish.outputs.summary }}
        DELIMITER
        )
        exit_code=0
        echo "$summary"
        
        # Check that the summary includes our custom formatting
        if echo "$summary" | grep -q "ğŸš€ Container Build Results"; then
          echo "âœ… Summary includes custom header"
        else
          echo "âŒ Summary missing custom header"
          exit_code=1
        fi
        
        # Check that version was included
        if echo "$summary" | grep -q "Version:" | grep -q "1.0.0"; then
          echo "âœ… Summary includes version"
        else
          echo "âŒ Summary missing version"
          exit_code=1
        fi
        
        # Check that the table header was rendered
        if echo "$summary" | grep -q "| Tag | Full Name |"; then
          echo "âœ… Summary includes table formatting"
        else
          echo "âŒ Summary missing table formatting"
          exit_code=1
        fi
        
        # Check that JSON formatting was applied
        if echo "$summary" | grep -q '```json'; then
          echo "âœ… Summary includes JSON code block"
        else
          echo "âŒ Summary missing JSON code block"
          exit_code=1
        fi

        exit $exit_code

    - id: publishComplex
      name: Run publish-container action with complex template including conditionals
      uses: ./
      if: always()
      with:
        registryHost: localhost:5000
        registryUsername: testuser
        registryPassword: testpassword
        imageNames: localhost:5000/test-complex-template
        version: 2.0.0-beta.1
        context: tests/custom-template-test
        dockerfile: tests/custom-template-test/Dockerfile
        messageTemplate: |-
          # Build Summary for {{ repo }}
          
          {% if version is defined and version.endswith('-beta.1') %}
          > âš ï¸ **Beta Release**: This is a pre-release version
          {% endif %}
          
          ## Images Built
          {% for image in images %}
          - {{ image }}
            {% if 'complex' in image %}
            (Complex template test)
            {% endif %}
          {% endfor %}
          
          ## Tag Count: {{ tags | length }}

    - name: Assert complex template with conditionals was rendered correctly
      shell: bash
      if: always()
      run: |
        summary=$(cat << 'DELIMITER'
        ${{ steps.publishComplex.outputs.summary }}
        DELIMITER
        )
        exit_code=0
        echo "$summary"
        
        # Check that conditional was rendered
        if echo "$summary" | grep -q "âš ï¸ \*\*Beta Release\*\*"; then
          echo "âœ… Summary includes conditional beta warning"
        else
          echo "âŒ Summary missing conditional beta warning"
          exit_code=1
        fi
        
        # Check that the image name conditional was rendered
        if echo "$summary" | grep -q "(Complex template test)"; then
          echo "âœ… Summary includes nested conditional text"
        else
          echo "âŒ Summary missing nested conditional text"
          exit_code=1
        fi
        
        # Check that the filter/function was applied
        if echo "$summary" | grep -q "Tag Count:"; then
          echo "âœ… Summary includes tag count from filter"
        else
          echo "âŒ Summary missing tag count from filter"
          exit_code=1
        fi

        exit $exit_code
