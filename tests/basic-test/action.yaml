name: Publish container publishes expected container
description: Test to validate that publish container publishes expected container

runs:
  using: composite
  steps:
    - id: publish
      name: Run publish-container action
      uses: ./
      with:
        registryHost: localhost:5000
        registryUsername: testuser
        registryPassword: testpassword
        imageNames: localhost:5000/test-image
        version: 2.3.4
        context: tests/basic-test
        dockerfile: tests/basic-test/Dockerfile

    - name: Assert contains expected tags
      shell: bash
      run: |
        tags=$(curl -s -u testuser:testpassword http://localhost:5000/v2/test-image/tags/list | jq -r '.tags[]')
        
        # Check for specific version tags
        for tag in "2.3.4" "2.3" "2"; do
          if echo "$tags" | grep -q "$tag"; then
            echo "✅ Found expected tag: $tag"
          else
            echo "❌ Missing expected tag: $tag"
            exit 1
          fi
        done
        
    - name: Assert container runs
      shell: bash
      run: |
        docker pull localhost:5000/test-image:2.3.4
        output=$(docker run --rm localhost:5000/test-image:2.3.4)

        if [ "$output" = "This is a test container" ]; then
          echo "✅ Container runs correctly with expected output"
        else
          echo "❌ Container output does not match expected: $output"
          exit 1
        fi

    - name: Assert container contains expected labels
      shell: bash
      run: |
        label=$(docker inspect localhost:5000/test-image:2.3.4 | jq -r '.[0].Config.Labels["test.label"]')
        if [ "$label" = "basic-test" ]; then
          echo "✅ Container has expected label"
        else
          echo "❌ Container missing expected label: $label"
          exit 1
        fi
        
    - name: Assert output includes expected information
      shell: bash
      run: |
        echo "${{ steps.publish.outputs.summary }}"
        
        if [ -n "${{ steps.publish.outputs.summary }}" ]; then
          echo "✅ Summary output exists"
        else
          echo "❌ Missing summary output"
          exit 1
        fi
        
        if echo "${{ steps.publish.outputs.summary }}" | grep -q "2.3.4"; then
          echo "✅ Summary contains version information"
        else
          echo "❌ Summary missing version information"
          exit 1
        fi

